<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- CSRF (n·∫øu b·∫°n b·∫≠t Spring Security CSRF) -->
  <meta name="_csrf" th:content="${_csrf.token}"/>

  <title>Trang Ch·ªß | SportShop</title>
  <!-- Li√™n k·∫øt ƒë·∫øn Font Awesome cho bi·ªÉu t∆∞·ª£ng -->
  <link
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
          rel="stylesheet"
  />
  <link
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          rel="stylesheet"
  />
  <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />
  <link rel="stylesheet" th:href="@{/css/web/header.css}" />
  <link rel="stylesheet" th:href="@{/css/web/nav.css}" />
  <link rel="stylesheet" th:href="@{/css/web/footer.css}" />
  <link rel="stylesheet" th:href="@{/css/web/home.css}" />

  <!-- Chat styles -->
  <style>
    /* Khung chat */
    #ss-chat{
      position:fixed;right:24px;bottom:24px;width:340px;max-height:70vh;background:#fff;
      border:1px solid #eaeaea;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);
      display:flex;flex-direction:column;overflow:hidden;z-index:1000
    }
    #ss-chat header{
      padding:10px 12px;font-weight:700;background:#f7f9fc;
      display:flex;align-items:center;justify-content:space-between;gap:8px
    }
    #ss-title{display:flex;align-items:center;gap:8px}
    #ss-title .dot{width:8px;height:8px;border-radius:999px;background:#2ecc71}
    #ss-log{padding:10px;overflow:auto;flex:1;background:#fbfcfe}
    #ss-input{display:flex;gap:6px;border-top:1px solid #eee;padding:8px;background:white}
    #ss-input input{flex:1;padding:10px;border:1px solid #ddd;border-radius:10px}
    #ss-chat.min{height:46px;max-height:46px}
    #ss-toggle{cursor:pointer;user-select:none}

    /* Bong b√≥ng chat */
    .ss-msg{margin:8px 0;display:flex;gap:8px;align-items:flex-end}
    .ss-msg.user{justify-content:flex-end}
    .ss-msg.ai{justify-content:flex-start}
    .ss-bubble{
      padding:10px 12px;border-radius:14px;max-width:78%;line-height:1.35;
      word-break:break-word;white-space:pre-wrap
    }
    .ss-msg.user .ss-bubble{
      background:#3498db;color:white;border-bottom-right-radius:4px
    }
    .ss-msg.ai .ss-bubble{
      background:#eef2f7;color:#222;border-bottom-left-radius:4px
    }
    .ss-avatar{
      width:28px;height:28px;border-radius:50%;object-fit:cover;flex:0 0 28px
    }
    .ss-typing{font-style:italic;color:#888;margin:4px 6px}
    .ss-actions{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 4px}
    .ss-chip{
      border:1px solid #d9e1ec;background:#fff;border-radius:16px;padding:6px 10px;cursor:pointer;
      font-size:12px
    }

    /* N√∫t thu/ph√≥ng */
    .ss-icon-btn{background:transparent;border:0;color:#667085;cursor:pointer}
    .ss-icon-btn:hover{color:#344054}
  </style>
</head>
<body id="top">
<!-- Ph·∫ßn ƒê·∫ßu Trang -->
<header class="header">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between">
      <a href="/home" class="d-flex align-items-center text-decoration-none">
        <img class="logo" th:src="@{/image/logo.jpg}" alt="Logo" />
        <h1 class="header-title">Sport Shop</h1>
      </a>

      <div class="d-flex align-items-center">
        <form
                class="form-inline mr-3"
                th:action="@{/home/search-name}"
                method="post"
                onsubmit="return checkSearch()"
        >
          <div class="input-group">
            <input
                    id="search"
                    class="form-control"
                    type="search"
                    placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
                    aria-label="Search"
                    name="name"
                    th:value="${name}"
            />
            <div class="input-group-append">
              <button class="btn btn-custom" type="submit">
                <i class="fas fa-search"></i> T√¨m
              </button>
            </div>
          </div>
        </form>

        <!-- Hi·ªÉn th·ªã n√∫t ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω khi ch∆∞a ƒëƒÉng nh·∫≠p -->
        <th:block th:if="${user == null}">
          <a th:href="@{/login}" class="btn btn-custom mr-2">
            <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
          </a>
          <a th:href="@{/register}" class="btn btn-custom">
            <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω
          </a>
        </th:block>

        <!-- Hi·ªÉn th·ªã c√°c n√∫t kh√°c khi ƒë√£ ƒëƒÉng nh·∫≠p -->
        <th:block th:if="${user != null}">
          <div class="dropdown mr-2">
            <button
                    class="btn btn-custom dropdown-toggle"
                    type="button"
                    id="userDropdown"
                    data-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false">
              <i class="fas fa-user"></i>
              <span th:text="${user.username}">T√†i kho·∫£n</span>
            </button>

            <div class="dropdown-menu" aria-labelledby="userDropdown">
              <a class="dropdown-item" th:href="@{/user/info}">
                <i class="fas fa-user-circle"></i> Th√¥ng tin t√†i kho·∫£n
              </a>

              <a class="dropdown-item" th:href="@{/user/history(status='Dang_Xu_Ly')}">
                <i class="fas fa-history"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng
              </a>

              <div class="dropdown-divider"></div>

              <!-- ƒêƒÉng xu·∫•t b·∫±ng POST + CSRF, v·∫´n gi·ªØ style dropdown-item -->
              <form th:action="@{/logout}" method="post" class="m-0">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="dropdown-item">
                  <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </button>
              </form>
            </div>
          </div>

          <a
                  th:href="@{/user/cart/{id}(id=${user.id})}"
                  class="btn btn-custom position-relative mr-2">
            <i class="fas fa-shopping-cart"></i> Gi·ªè h√†ng
            <span
                    th:text="${quantity}"
                    class="badge badge-danger position-absolute"
                    style="top: -5px; right: -5px">0</span>
          </a>
        </th:block>
      </div>
    </div>
  </div>
</header>

<div class="nav-container">
  <div class="container">
    <button class="menu-toggle" onclick="toggleMenu()">
      <i class="fas fa-bars"></i> Menu
    </button>
    <nav class="nav nav-pills nav-justified" style="font-size: 0.9rem">
      <a class="nav-link" href="#top">
        <i class="fas fa-home"></i> Trang Ch·ªß
      </a>
      <a class="nav-link" href="#brand">
        <i class="fas fa-box"></i> Th∆∞∆°ng Hi·ªáu
      </a>
      <a class="nav-link" href="#newest-products">
        <i class="fas fa-star"></i> M·ªõi Nh·∫•t
      </a>
      <a class="nav-link" href="#sale-products">
        <i class="fas fa-percentage"></i> Khuy·∫øn M√£i
      </a>
      <a class="nav-link" th:href="@{/home/introduce}">
        <i class="fas fa-info-circle"></i> Gi·ªõi Thi·ªáu
      </a>
      <a class="nav-link" th:href="@{/home/contact}">
        <i class="fas fa-phone"></i> Li√™n H·ªá
      </a>
    </nav>
  </div>
</div>

<div class="container-fluid">
  <div
          id="bannerCarousel"
          class="carousel slide banner-slider"
          data-ride="carousel"
          data-interval="3000">
    <ol class="carousel-indicators">
      <li data-target="#bannerCarousel" data-slide-to="0" class="active"></li>
      <li data-target="#bannerCarousel" data-slide-to="1"></li>
      <li data-target="#bannerCarousel" data-slide-to="2"></li>
    </ol>
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img th:src="@{/image/banner1.jpg}" alt="Banner 1" />
      </div>
      <div class="carousel-item">
        <img th:src="@{/image/banner2.jpg}" alt="Banner 2" />
      </div>
      <div class="carousel-item">
        <img th:src="@{/image/banner3.jpg}" alt="Banner 3" />
      </div>
    </div>
    <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng m·ªõi -->
    <button
            class="carousel-nav prev"
            onclick="$('#bannerCarousel').carousel('prev')">
      <i class="fas fa-chevron-left"></i>
    </button>
    <button
            class="carousel-nav next"
            onclick="$('#bannerCarousel').carousel('next')">
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</div>

<section class="brands-section" id="brand">
  <div class="container">
    <h3>TH∆Ø∆†NG HI·ªÜU</h3>
    <hr />
    <div class="brands-grid">
      <div class="brand-card" th:each="brand : ${brands}">
        <div class="brand-image">
          <img th:src="${brand.image}" th:alt="${brand.name}" />
        </div>
        <h4 th:text="${brand.name}">Brand Name</h4>
        <a th:href="@{/home/search/{id}(id=${brand.id})}" class="btn btn-primary">
          Xem S·∫£n Ph·∫©m
        </a>
      </div>
    </div>
  </div>
</section>

<!-- Ph·∫ßn S·∫£n Ph·∫©m M·ªõi -->
<section class="list_new_product" id="newest-products">
  <h3>S·∫¢N PH·∫®M M·ªöI</h3>
  <hr />
  <div id="productCarousel" class="carousel slide" data-ride="carousel">
    <div class="carousel-inner">
      <!-- Slide ƒë·∫ßu ti√™n (active) -->
      <div class="carousel-item active">
        <div class="row">
          <div class="col-md-3" th:each="product, stat : ${productDates}" th:if="${stat.index < 4}">
            <div class="product-card">
              <div class="product-image">
                <div class="image-container">
                  <img
                          th:each="image, imageStat : ${product.images}"
                          th:src="${image.imageLink}"
                          th:class="${imageStat.first} ? 'active' : ''"
                          alt="Product Image"/>
                </div>
                <div class="image-nav">
                  <button
                          th:each="image, imageStat : ${product.images}"
                          th:class="${imageStat.first} ? 'image-nav-btn active' : 'image-nav-btn'"
                          th:onclick="'changeImage(this, ' + ${imageStat.index} + ')'">
                  </button>
                </div>
              </div>
              <h4 th:text="${product.name}">Product Name</h4>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <span class="product-price" th:text="${product.price} + ' VNƒê'">Price</span>
                  <span class="badge badge-danger" th:text="'Gi·∫£m ' + ${product.discount} + '%'">Discount</span>
                </div>
                <a th:href="@{/home/product/{id}(id=${product.id})}" class="btn btn-primary">Chi ti·∫øt</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Slide th·ª© hai -->
      <div class="carousel-item" th:if="${quantityProduct > 4}">
        <div class="row">
          <div class="col-md-3" th:each="product, stat : ${productDates}" th:if="${stat.index >= 4 && stat.index < 8}">
            <!-- N·ªôi dung gi·ªëng slide 1 -->
            <div class="product-card">
              <div class="product-image">
                <div class="image-container">
                  <img
                          th:each="image, imageStat : ${product.images}"
                          th:src="${image.imageLink}"
                          th:class="${imageStat.first} ? 'active' : ''"
                          alt="Product Image"/>
                </div>
                <div class="image-nav">
                  <button
                          th:each="image, imageStat : ${product.images}"
                          th:class="${imageStat.first} ? 'image-nav-btn active' : 'image-nav-btn'"
                          th:onclick="'changeImage(this, ' + ${imageStat.index} + ')'">
                  </button>
                </div>
              </div>
              <h4 th:text="${product.name}">Product Name</h4>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <span class="product-price" th:text="${product.price} + ' VNƒê'">Price</span>
                  <span class="badge badge-danger" th:text="'Gi·∫£m ' + ${product.discount} + '%'">Discount</span>
                </div>
                <a th:href="@{/home/product/{id}(id=${product.id})}" class="btn btn-primary">Chi ti·∫øt</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng -->
    <a class="carousel-control-prev" href="#productCarousel" role="button" data-slide="prev" th:if="${quantityProduct > 4}">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#productCarousel" role="button" data-slide="next" th:if="${quantityProduct > 4}">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>
</section>

<!-- S·∫¢N PH·∫®M HOT -->
<section class="list_spbanhchay" id="sale-products">
  <h3>S·∫¢N PH·∫®M HOT</h3>
  <hr />
  <div id="productSaleCarousel" class="carousel slide" data-ride="carousel">
    <div class="carousel-inner">
      <!-- Slide ƒë·∫ßu ti√™n (active) -->
      <div class="carousel-item active">
        <div class="row">
          <div class="col-md-3" th:each="product, stat : ${productSales}" th:if="${stat.index < 4}">
            <div class="product-card">
              <div class="product-image">
                <div class="image-container">
                  <img
                          th:each="image, imageStat : ${product.images}"
                          th:src="${image.imageLink}"
                          th:class="${imageStat.first} ? 'active' : ''"
                          alt="Product Image"/>
                </div>
                <div class="image-nav">
                  <button
                          th:each="image, imageStat : ${product.images}"
                          th:class="${imageStat.first} ? 'image-nav-btn active' : 'image-nav-btn'"
                          th:onclick="'changeImage(this, ' + ${imageStat.index} + ')'">
                  </button>
                </div>
              </div>
              <h4 th:text="${product.name}">Product Name</h4>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <span class="product-price" th:text="${product.price} + ' VNƒê'">Price</span>
                  <span class="badge badge-danger" th:text="'Gi·∫£m ' + ${product.discount} + '%'">Discount</span>
                </div>
                <a th:href="@{/home/product/{id}(id=${product.id})}" class="btn btn-primary">Chi ti·∫øt</a>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Slide th·ª© hai -->
      <div class="carousel-item" th:if="${quantityProduct > 4}">
        <div class="row">
          <div class="col-md-3" th:each="product, stat : ${productSales}" th:if="${stat.index >= 4 && stat.index < 8}">
            <div class="product-card">
              <div class="product-image">
                <div class="image-container">
                  <img
                          th:each="image, imageStat : ${product.images}"
                          th:src="${image.imageLink}"
                          th:class="${imageStat.first} ? 'active' : ''"
                          alt="Product Image"/>
                </div>
                <div class="image-nav">
                  <button
                          th:each="image, imageStat : ${product.images}"
                          th:class="${imageStat.first} ? 'image-nav-btn active' : 'image-nav-btn'"
                          th:onclick="'changeImage(this, ' + ${imageStat.index} + ')'">
                  </button>
                </div>
              </div>
              <h4 th:text="${product.name}">Product Name</h4>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <span class="product-price" th:text="${product.price} + ' VNƒê'">Price</span>
                  <span class="badge badge-danger" th:text="'Gi·∫£m ' + ${product.discount} + '%'">Discount</span>
                </div>
                <a th:href="@{/home/product/{id}(id=${product.id})}" class="btn btn-primary">Chi ti·∫øt</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng -->
    <a class="carousel-control-prev" href="#productSaleCarousel" role="button" data-slide="prev" th:if="${quantityProduct > 4}">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#productSaleCarousel" role="button" data-slide="next" th:if="${quantityProduct > 4}">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>
</section>

<!-- Chat bot (ƒë√£ n√¢ng c·∫•p UI) -->
<div id="ss-chat" class="min">
  <header id="ss-toggle" title="B·∫•m ƒë·ªÉ m·ªü/thu g·ªçn">
    <div id="ss-title"><span class="dot"></span> <span>SportShop Chat</span></div>
    <div>
      <button class="ss-icon-btn" aria-label="Minimize"><i class="fa fa-chevron-up"></i></button>
    </div>
  </header>
  <div id="ss-log" hidden>
    <div class="ss-actions">
      <button class="ss-chip" onclick="quickBestSellers()">T∆∞ v·∫•n s·∫£n ph·∫©m b√°n ch·∫°y</button>

      <button class="ss-chip" onclick="quickOrderHistory()">Tra c·ª©u tr·∫°ng th√°i ƒë∆°n h√†ng</button>

    </div>
  </div>
  <div id="ss-input" hidden>
    <input id="ss-msg" placeholder="Nh·∫≠p c√¢u h·ªèi..." />
    <button id="ss-send" class="btn btn-primary btn-sm">G·ª≠i</button>
  </div>

</div>

<!-- Ph·∫ßn Ch√¢n Trang -->
<footer>
  <div class="footer_container">
    <div class="footer-column">
      <h3>ƒê·ªãa ƒëi·ªÉm c·ª≠a h√†ng</h3>
      <p>
        <strong>TR·ª§ S·ªû:</strong> Tr∆∞·ªùng ƒê·∫°i H·ªçc T√†i Nguy√™n V√† M√¥i Tr∆∞·ªùng H√† N·ªôi<br />
        S·ªë 41A ƒë∆∞·ªùng Ph√∫ Di·ªÖn, ph∆∞·ªùng Ph√∫ Di·ªÖn, qu·∫≠n B·∫Øc T·ª´ Li√™m, th√†nh ph·ªë H√† N·ªôi
      </p>
    </div>
    <div class="footer-column">
      <h3>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i</h3>
      <ul class="social-icons">
        <li><a href="https://www.facebook.com/chotung.mrt/"><i class="fab fa-facebook-f"></i></a></li>
        <li><a href="https://www.facebook.com/chotung.mrt/"><i class="fab fa-youtube"></i></a></li>
        <li><a href="https://www.facebook.com/chotung.mrt/"><i class="fab fa-instagram"></i></a></li>
      </ul>
    </div>
  </div>
  <div class="container text-center">
    <p>&copy; 2025 Sport Shop. All Rights Reserved.</p>
    <a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a> | <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
  </div>
</footer>

<!-- JS ph·∫ßn UI v√† carousel (gi·ªØ nguy√™n c·ªßa b·∫°n) -->
<script>
  function toggleMenu() {
    const navPills = document.querySelector('.nav-pills');
    navPills.classList.toggle('show');
  }
  document.addEventListener('click', function(event) {
    const navPills = document.querySelector('.nav-pills');
    const menuToggle = document.querySelector('.menu-toggle');
    if (!navPills.contains(event.target) && !menuToggle.contains(event.target)) {
      navPills.classList.remove('show');
    }
  });
  function changeImage(button, index) {
    const productCard = button.closest(".product-card");
    productCard.querySelectorAll(".image-container img").forEach((img) => img.classList.remove("active"));
    productCard.querySelectorAll(".image-nav-btn").forEach((btn) => btn.classList.remove("active"));
    productCard.querySelectorAll(".image-container img")[index].classList.add("active");
    button.classList.add("active");
  }
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const navLinks = document.querySelectorAll(".nav-link");
    navLinks.forEach((link) => {
      link.addEventListener("click", function (e) {
        if (this.getAttribute("href").startsWith("#")) {
          e.preventDefault();
          const targetId = this.getAttribute("href");
          if (targetId === "#top") {
            window.scrollTo({ top: 0, behavior: "smooth" });
          } else {
            const targetElement = document.querySelector(targetId);
            if (targetElement) targetElement.scrollIntoView({ behavior: "smooth", block: "start" });
          }
          navLinks.forEach((l) => l.classList.remove("active"));
          this.classList.add("active");
        }
      });
    });
    window.addEventListener("scroll", function () {
      let current = "";
      const sections = document.querySelectorAll("div[id]");
      const scrollPos = window.pageYOffset;
      if (scrollPos < 100) {
        navLinks.forEach((link) => {
          link.classList.remove("active");
          if (link.getAttribute("href") === "#top") link.classList.add("active");
        });
        return;
      }
      sections.forEach((section) => {
        const sectionTop = section.offsetTop;
        if (scrollPos >= sectionTop - 60) current = section.getAttribute("id");
      });
      navLinks.forEach((link) => {
        link.classList.remove("active");
        if (link.getAttribute("href") === `#${current}`) link.classList.add("active");
      });
    });
  });
</script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const productCarousel = document.getElementById("productCarousel");
    if (productCarousel) {
      const productSlides = productCarousel.querySelectorAll(".carousel-item");
      const productControls = productCarousel.querySelectorAll(".carousel-control-prev, .carousel-control-next");
      if (productSlides.length <= 1) productControls.forEach((c) => (c.style.display = "none"));
      else productControls.forEach((c) => (c.style.display = "flex"));
    }
    const saleCarousel = document.getElementById("productSaleCarousel");
    if (saleCarousel) {
      const saleSlides = saleCarousel.querySelectorAll(".carousel-item");
      const saleControls = saleCarousel.querySelectorAll(".carousel-control-prev, .carousel-control-next");
      if (saleSlides.length <= 1) saleControls.forEach((c) => (c.style.display = "none"));
      else saleControls.forEach((c) => (c.style.display = "flex"));
    }
  });
</script>
<script>
  $(document).ready(function () {
    $("#bannerCarousel").carousel({ interval: 3000, wrap: true, keyboard: true });
    $(".carousel").hover(function () { $(this).carousel("pause"); }, function () { $(this).carousel("cycle"); });
  });
</script>
<script>
  function checkSearch() {
    var checkSearch = document.getElementById("search").value;
    if (checkSearch == null || checkSearch.trim() === "") {
      window.alert("Vui L√≤ng Nh·∫≠p T√¨m Ki·∫øm");
      return false;
    }
    return true;
  }
</script>
<script>
  const el = (id)=>document.getElementById(id);
  let conversationId=null;

  // Toggle open/close
  el('ss-toggle').onclick=()=>{
    const box=el('ss-chat');
    const min=box.classList.toggle('min');
    el('ss-log').hidden=min; el('ss-input').hidden=min;
  };

  function getCsrf(){
    const m = document.querySelector('meta[name="_csrf"]');
    return m ? m.getAttribute('content') : '';
  }
  function avatarFor(role){ return role==='AI' ? '/image/bot.png' : '/image/user.png'; }
  function appendMsg(sender, html){
    const cls = sender==='USER'?'user':'ai';
    const tpl = `
      <div class="ss-msg ${cls}">
        ${sender==='AI'?`<img class="ss-avatar" src="${avatarFor('AI')}" onerror="this.style.display='none'">`:''}
        <div class="ss-bubble">${html}</div>
        ${sender==='USER'?`<img class="ss-avatar" src="${avatarFor('USER')}" onerror="this.style.display='none'">`:''}
      </div>`;
    el('ss-log').insertAdjacentHTML('beforeend', tpl);
    el('ss-log').scrollTop=el('ss-log').scrollHeight;
  }
  function showTyping(){ const d=document.createElement('div'); d.id='ss-typing'; d.className='ss-typing'; d.textContent='Bot ƒëang tr·∫£ l·ªùi...'; el('ss-log').appendChild(d); el('ss-log').scrollTop=el('ss-log').scrollHeight; }
  function hideTyping(){ const t=document.getElementById('ss-typing'); if(t) t.remove(); }
  function quick(text){ el('ss-msg').value=text; send(); }

  // ===== Best sellers =====
  function renderProducts(items){
    if(!Array.isArray(items) || !items.length){ appendMsg('AI','Hi·ªán ch∆∞a c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m b√°n ch·∫°y.'); return; }
    let html = '<b>üî• S·∫£n ph·∫©m b√°n ch·∫°y:</b><br/>';
    html += items.map(p => `
      <div style="margin:6px 0; padding:6px; border:1px solid #eee; border-radius:8px; background:#fff;">
        <img src="${p.thumbnailUrl || '/images/no-image.png'}"
             style="width:60px;height:60px;object-fit:cover;border-radius:6px;vertical-align:middle;margin-right:8px"/>
        <b>${p.name}</b> ‚Äî ${Number(p.price||0).toLocaleString()}‚Ç´
        <div style="margin-top:4px">
          <a href="${p.detailUrl}" style="color:#3498db;text-decoration:none;">üëâ Xem chi ti·∫øt</a>
        </div>
      </div>
    `).join('');
    appendMsg('AI', html);
  }

  async function quickBestSellers(){
    appendMsg('USER','T∆∞ v·∫•n s·∫£n ph·∫©m b√°n ch·∫°y');
    showTyping();
    try{
      const res = await fetch('/api/chat/best-sellers', { credentials:'same-origin' });
      const items = await res.json();
      hideTyping();
      renderProducts(items);
    }catch(e){
      hideTyping();
      appendMsg('AI','Xin l·ªói, kh√¥ng l·∫•y ƒë∆∞·ª£c danh s√°ch s·∫£n ph·∫©m.');
    }
  }
  window.quickBestSellers = quickBestSellers;

  // ===== L·ªãch s·ª≠ ƒë∆°n (KH√îNG hi·ªÉn th·ªã date) =====
  function renderOrderList(orders){
    if(!Array.isArray(orders) || !orders.length){ appendMsg('AI','B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.'); return; }
    let html = '<b>üì¶ L·ªãch s·ª≠ ƒë∆°n h√†ng c·ªßa b·∫°n:</b><br/>';
    html += orders.map(o => `
      <div class="ss-chip" style="display:inline-block;margin:6px 6px 0 0;padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fff">
        ${o.code} ¬∑ ${o.status} ¬∑ ${Number(o.total||0).toLocaleString()}‚Ç´
      </div>
    `).join('');
    appendMsg('AI', html);
  }

  async function quickOrderHistory(){
    appendMsg('USER','Tra c·ª©u tr·∫°ng th√°i ƒë∆°n h√†ng');
    showTyping();
    try{
      const res = await fetch('/api/chat/my-orders', { method:'GET', credentials:'same-origin' });
      hideTyping();
      if(res.status === 401){
        appendMsg('AI','Vui l√≤ng <a href="/login">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ xem l·ªãch s·ª≠ ƒë∆°n h√†ng.');
        return;
      }
      const orders = await res.json();
      renderOrderList(orders);
    }catch(e){
      hideTyping();
      appendMsg('AI','Xin l·ªói, kh√¥ng l·∫•y ƒë∆∞·ª£c l·ªãch s·ª≠ ƒë∆°n h√†ng.');
    }
  }
  window.quickOrderHistory = quickOrderHistory;

  // ===== Chat AI chung (gi·ªØ n·∫øu c·∫ßn) =====
  async function send(){
    const m = el('ss-msg').value.trim();
    if(!m) return;
    appendMsg('USER', m);
    el('ss-msg').value='';
    showTyping();
    try{
      const res = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRF-TOKEN': getCsrf()},
        credentials:'same-origin',
        body: JSON.stringify({conversationId, message:m})
      });
      const data = await res.json();
      hideTyping();
      appendMsg('AI', data.answer || '...');
    }catch(e){
      hideTyping();
      appendMsg('AI','Xin l·ªói, h·ªá th·ªëng ƒëang b·∫≠n. Vui l√≤ng th·ª≠ l·∫°i sau.');
    }
  }
  el('ss-send').onclick=send;
  el('ss-msg').addEventListener('keydown',e=>{ if(e.key==='Enter') send(); });
</script>


<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
  let stompClient = null;

  function connectWs(conversationId){
    if(stompClient) return;
    const socket = new SockJS('/ws-chat');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, ()=> {
      stompClient.subscribe('/topic/conversation.'+conversationId, (message)=>{
        const msg = JSON.parse(message.body);
        if(msg.senderType==='ADMIN'){
          appendMsg('AI', '<b>Nh√¢n vi√™n:</b> '+msg.content);
        }
      });
    });
  }

  // Khi user b·∫•m ‚ÄúNh√¢n vi√™n‚Äù
  el('ss-handoff').onclick=()=>{
    if(!conversationId){
      appendMsg('AI', '<i>üí° Vui l√≤ng g·ª≠i 1 c√¢u h·ªèi tr∆∞·ªõc ƒë·ªÉ kh·ªüi t·∫°o h·ªôi tho·∫°i.</i>');
      return;
    }
    appendMsg('AI', '<i>ƒê√£ chuy·ªÉn b·∫°n sang nh√¢n vi√™n h·ªó tr·ª£.</i>');
    connectWs(conversationId);
  };
</script>

</body>
</html>
