<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chi Tiết Sản Phẩm | SportShop</title>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>

  <link rel="stylesheet" th:href="@{/css/web/header.css}" />
  <link rel="stylesheet" th:href="@{/css/web/nav.css}" />
  <link rel="stylesheet" th:href="@{/css/web/footer.css}" />
  <link rel="stylesheet" th:href="@{/css/web/product-detail.css}" />

  <style>
    /* --- Rating UI (nhẹ) --- */
    .reviews-section { margin-top: 2rem; }
    .reviews-title { font-weight: 700; margin-bottom: 1rem; }
    .reviews-summary .score-display { font-size: 42px; font-weight: 800; line-height: 1; }
    .stars i { opacity: .3; color: #f59e0b; }
    .stars i.filled { opacity: 1; }
    .stars-sm i { font-size: 14px; margin-right: 2px; }
    .dist-row { display: flex; align-items: center; margin: 6px 0; gap: 10px; }
    .dist-label { width: 70px; text-align: right; white-space: nowrap; }
    .star-mini { font-size: 12px; color: #f59e0b; }
    .dist-bar { flex: 1; height: 8px; border-radius: 4px; background: #eee; overflow: hidden; }
    .dist-fill { height: 100%; background: linear-gradient(90deg,#fbbf24,#f59e0b); }
    .review-item .review-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; }
    .review-photo { width: 84px; height: 84px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }
    .admin-reply { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 12px; }
    .admin-reply-header { font-weight: 600; margin-bottom: 4px; }

    /* Ảnh sản phẩm */
    .product-gallery .main-image img { width: 100%; border-radius: 8px; }
    .thumbnail-container { margin-top: 10px; display: grid; grid-template-columns: repeat(5,1fr); gap: 8px; }
    .thumbnail { width: 100%; height: 70px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; cursor: pointer; }
    .thumbnail.active { outline: 2px solid #f59e0b; }

    /* GIÁ + GIẢM GIÁ */
    .product-price{ display:flex; align-items:center; gap:12px; }
    .product-discount{
      display:inline-flex; align-items:center;
      padding:6px 14px; border-radius:20px;
      background:#e74c3c; color:#fff !important;
      font-weight:700; font-size:16px !important;
      line-height:1.2; white-space:nowrap;
    }

    /* --- Shopee-like Description --- */
    .desc-card .card-header{
      background:#fff7ed; border-bottom:1px solid #fde68a;
      font-weight:700; color:#d97706;
    }
    .desc-content.collapsed{
      display:-webkit-box; -webkit-line-clamp:6; -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .btn-link-like{
      background:#fff; border:1px solid #eee; border-radius:999px;
      padding:6px 12px; font-weight:600; color:#2563eb; text-decoration:none;
    }
    .btn-link-like:hover{ text-decoration:none; background:#f8fafc; }

    /* --- Review filter pills --- */
    .review-filters{ display:flex; flex-wrap:wrap; gap:8px; }
    .filter-pill{
      border:1px solid #e5e7eb; background:#fff; border-radius:999px;
      padding:6px 12px; font-weight:600; cursor:pointer; user-select:none;
    }
    .filter-pill.active{ border-color:#f97316; color:#f97316; background:#fff7ed; }
  </style>
</head>
<body>
<header class="header">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between">
      <a th:href="@{/home}" class="d-flex align-items-center text-decoration-none">
        <img class="logo" th:src="@{/image/logo.jpg}" alt="Logo" />
        <h1 class="header-title">Sport Shop</h1>
      </a>

      <div class="d-flex align-items-center">
        <form class="form-inline mr-3" th:action="@{/home/search-name}" method="get">
          <div class="input-group">
            <input class="form-control" type="search" placeholder="Tìm kiếm sản phẩm..." aria-label="Search" name="name" th:value="${name}"/>
            <div class="input-group-append">
              <button class="btn btn-custom" type="submit">
                <i class="fas fa-search"></i> Tìm
              </button>
            </div>
          </div>
        </form>

        <!-- Chưa đăng nhập -->
        <th:block th:if="${user == null}">
          <a th:href="@{/login}" class="btn btn-custom mr-2">
            <i class="fas fa-sign-in-alt"></i> Đăng nhập
          </a>
          <a th:href="@{/register}" class="btn btn-custom">
            <i class="fas fa-user-plus"></i> Đăng ký
          </a>
        </th:block>

        <!-- Đã đăng nhập -->
        <th:block th:if="${user != null}">
          <div class="dropdown mr-2">
            <button class="btn btn-custom dropdown-toggle" type="button" id="userDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-user"></i>
              <span th:text="${user.username}">Tài khoản</span>
            </button>
            <div class="dropdown-menu" aria-labelledby="userDropdown">
              <a class="dropdown-item" th:href="@{/user/info}">
                <i class="fas fa-user-circle"></i> Thông tin tài khoản
              </a>
              <a class="dropdown-item" th:href="@{/user/history}">
                <i class="fas fa-history"></i> Lịch sử đơn hàng
              </a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" th:href="@{/logout}">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
              </a>
            </div>
          </div>

          <a th:href="@{/user/cart/{id}(id=${user.id})}" class="btn btn-custom position-relative mr-2">
            <i class="fas fa-shopping-cart"></i> Giỏ hàng
            <span th:text="${count}" class="badge badge-danger position-absolute" style="top: -5px; right: -5px">0</span>
          </a>
        </th:block>
      </div>
    </div>
  </div>
</header>

<div class="product-detail">
  <div class="container">
    <div class="row">
      <!-- Ảnh & gallery -->
      <div class="col-md-6">
        <div class="product-gallery">
          <div class="main-image">
            <img th:src="${(product != null && product.images != null && !#lists.isEmpty(product.images)) ? product.images.get(0).imageLink : '/image/no-image.png'}"
                 alt="Product Image" id="mainImage"/>
          </div>

          <div class="thumbnail-container" th:if="${product != null && product.images != null && !#lists.isEmpty(product.images)}">
            <img th:each="image,iter : ${product.images}"
                 th:src="${image.imageLink}"
                 th:classappend="${iter.index == 0} ? 'active'"
                 class="thumbnail"
                 onclick="changeImage(this.src)"
                 alt="Product Thumbnail"/>
          </div>
        </div>
      </div>

      <!-- Thông tin sản phẩm -->
      <div class="col-md-6">
        <div class="product-info">
          <h1 class="product-title"
              th:text="${product != null ? product.name : 'Tên Sản Phẩm'}">Tên Sản Phẩm</h1>

          <div class="brand-category-container">
            <div class="product-category"
                 th:text="${product != null && product.category != null ? product.category.name : 'Danh mục'}">Danh mục</div>
            <div class="product-brand"
                 th:text="${product != null && product.brand != null ? 'Thương hiệu: ' + product.brand.name : 'Thương hiệu'}">Thương hiệu</div>
          </div>

          <div class="product-brand"
               th:text="${product != null && product.color != null ? 'Màu Sắc: ' + product.color : 'Màu Sắc: -'}">Màu Sắc</div>
          <div class="product-brand"
               th:text="${product != null && product.quantity != null ? 'Số Lượng Còn Lại: ' + product.quantity : 'Số Lượng Còn Lại: 0'}">Số lượng</div>

          <!-- GIÁ + GIẢM GIÁ -->
          <div class="product-price"
               th:with="hasPrice=${product != null and product.price != null},
                        priceText=${hasPrice} ? |${#numbers.formatInteger(product.price,0)} VNĐ| : '0 VNĐ'">

            <span th:text="${priceText}">0 VNĐ</span>

            <span class="product-discount"
                  th:if="${product != null and product.discount != null and product.discount > 0}"
                  th:text="|Giảm ${product.discount}%|">
            </span>
          </div>


          <form class="form-inline mr-3"
                th:action="@{/user/cart/{id}(id=${product != null ? product.id : 0})}"
                method="post">
            <button class="add-to-cart-btn" type="submit">
              <i class="fas fa-shopping-cart"></i> Thêm vào giỏ hàng
            </button>
          </form>

          <div class="product-features-info">
            <h4><i class="fas fa-info-circle"></i> Thông tin sản phẩm</h4>
            <ul>
              <li><i class="fas fa-check-circle"></i> Sản phẩm chính hãng 100%</li>
              <li><i class="fas fa-shield-alt"></i> Bảo hành chất lượng 6 tháng</li>
              <li><i class="fas fa-exchange-alt"></i> Đổi size miễn phí trong 7 ngày</li>
              <li><i class="fas fa-truck"></i> Miễn phí giao hàng cho đơn từ 500K</li>
              <li><i class="fas fa-tshirt"></i> Tư vấn chọn size miễn phí</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ MÔ TẢ SẢN PHẨM (Shopee style) ============ -->
    <div class="card mb-4 desc-card" id="product-desc-block"
         th:if="${product != null && product.description != null && !#strings.isEmpty(product.description)}">
      <div class="card-header">
        <i class="fas fa-file-alt"></i> MÔ TẢ SẢN PHẨM
      </div>
      <div class="card-body">
        <div id="descContent"
             class="desc-content collapsed"
             th:utext="${#strings.replace(#strings.escapeXml(product.description), '\n', '<br/>')}">
        </div>
        <div class="mt-2">
          <button id="descToggleBtn" type="button" class="btn-link-like">Xem thêm</button>
        </div>
      </div>
    </div>
    <!-- ============ /MÔ TẢ SẢN PHẨM ============ -->

    <!-- ============ KHU VỰC HIỂN THỊ ĐÁNH GIÁ (Shopee style) ============ -->
    <div class="reviews-section"
         th:with="avg=${avgRating != null ? avgRating : 0.0},
                  total=${totalReviews != null ? totalReviews : 0}">
      <h3 class="reviews-title"><i class="fas fa-star"></i> Đánh giá sản phẩm</h3>

      <!-- Filter pills -->
      <div class="review-filters mb-3"
           th:with="total=${totalReviews != null ? totalReviews : 0}">
        <span class="filter-pill active" data-star="all">Tất cả
          <span class="text-muted" th:if="${total>0}">(<span th:text="${total}">0</span>)</span>
        </span>
        <span class="filter-pill" data-star="5">5 Sao
          <span class="text-muted" th:if="${starCounts != null}">(<span th:text="${starCounts.get(5) ?: 0}">0</span>)</span>
        </span>
        <span class="filter-pill" data-star="4">4 Sao
          <span class="text-muted" th:if="${starCounts != null}">(<span th:text="${starCounts.get(4) ?: 0}">0</span>)</span>
        </span>
        <span class="filter-pill" data-star="3">3 Sao
          <span class="text-muted" th:if="${starCounts != null}">(<span th:text="${starCounts.get(3) ?: 0}">0</span>)</span>
        </span>
        <span class="filter-pill" data-star="2">2 Sao
          <span class="text-muted" th:if="${starCounts != null}">(<span th:text="${starCounts.get(2) ?: 0}">0</span>)</span>
        </span>
        <span class="filter-pill" data-star="1">1 Sao
          <span class="text-muted" th:if="${starCounts != null}">(<span th:text="${starCounts.get(1) ?: 0}">0</span>)</span>
        </span>
      </div>

      <!-- TỔNG QUAN ĐÁNH GIÁ -->
      <div class="reviews-summary card mb-4"
           th:with="avg=${avgRating != null ? avgRating : 0.0},
                    total=${totalReviews != null ? totalReviews : 0}">
        <div class="card-body d-flex align-items-center">
          <div class="avg-score text-center pr-4 mr-4 border-right">
            <div class="score-display"
                 th:text="${#numbers.formatDecimal(avg, 1, 'POINT', 1, 'POINT')}">0.0</div>
            <div class="stars">
              <i class="fas fa-star" th:classappend="${avg>=1} ? ' filled'"></i>
              <i class="fas fa-star" th:classappend="${avg>=2} ? ' filled'"></i>
              <i class="fas fa-star" th:classappend="${avg>=3} ? ' filled'"></i>
              <i class="fas fa-star" th:classappend="${avg>=4} ? ' filled'"></i>
              <i class="fas fa-star" th:classappend="${avg>=5} ? ' filled'"></i>
            </div>
            <div class="total-reviews"><span th:text="${total}">0</span> đánh giá</div>
          </div>

          <div class="flex-grow-1">
            <!-- Phân bố 5→1 sao -->
            <div class="dist-row"
                 th:each="s : ${#numbers.sequence(5,1)}"
                 th:with="count=${starCounts != null ? starCounts.get(s) : 0},
                          pct=${total > 0 ? (count * 100.0 / total) : 0}">
              <span class="dist-label">
                <span th:text="${s}">5</span> <i class="fas fa-star star-mini"></i>
              </span>
              <div class="dist-bar">
                <div class="dist-fill" th:style="|width: ${pct}%;|"></div>
              </div>
              <span class="dist-count" th:text="${count}">0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- DANH SÁCH ĐÁNH GIÁ -->
      <div class="reviews-list">
        <div class="review-item card mb-3"
             th:each="c : ${comments}"
             th:attr="data-star=${c.rate != null ? c.rate : 0}">
          <div class="card-body">
            <div class="d-flex">
              <img class="review-avatar"
                   th:src="${c.user != null && c.user.avatar != null ? c.user.avatar : '/image/user-default.png'}"
                   alt="avatar"/>
              <div class="ml-3 flex-grow-1">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <strong class="review-username"
                            th:text="${c.user != null && c.user.fullName != null && !#strings.isEmpty(c.user.fullName) ? c.user.fullName : (c.user != null ? c.user.username : 'Người dùng')}">username</strong>
                    <div class="stars stars-sm ml-2">
                      <i class="fas fa-star" th:classappend="${c.rate!=null && c.rate>=1} ? ' filled'"></i>
                      <i class="fas fa-star" th:classappend="${c.rate!=null && c.rate>=2} ? ' filled'"></i>
                      <i class="fas fa-star" th:classappend="${c.rate!=null && c.rate>=3} ? ' filled'"></i>
                      <i class="fas fa-star" th:classappend="${c.rate!=null && c.rate>=4} ? ' filled'"></i>
                      <i class="fas fa-star" th:classappend="${c.rate!=null && c.rate>=5} ? ' filled'"></i>
                    </div>
                  </div>
                  <small class="text-muted"
                         th:text="${c.createDate != null ? #dates.format(c.createDate,'dd/MM/yyyy HH:mm') : ''}">01/09/2025 12:00</small>
                </div>

                <div class="review-message mt-2" th:text="${c.messages}">Nội dung đánh giá...</div>

                <div class="review-media mt-2" th:if="${c.mediaUrl != null}">
                  <a th:href="${c.mediaUrl}" target="_blank">
                    <img class="review-photo" th:src="${c.mediaUrl}" alt="photo"/>
                  </a>
                </div>

                <div class="admin-reply mt-3" th:if="${c.adminReply != null}">
                  <div class="admin-reply-header">
                    <i class="fas fa-store"></i> Phản hồi từ Shop
                    <small class="text-muted" th:if="${c.replyDate != null}"
                           th:text="${#dates.format(c.replyDate,'dd/MM/yyyy HH:mm')}">—</small>
                  </div>
                  <div class="admin-reply-body" th:text="${c.adminReply}">Nội dung phản hồi...</div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ============ /HIỂN THỊ ĐÁNH GIÁ ============ -->

  </div>
</div>

<!-- Service features -->
<div class="service-features">
  <div class="container">
    <div class="row">
      <div class="col-md-3">
        <div class="feature-box">
          <div class="feature-icon"><i class="fas fa-medal"></i></div>
          <h4>Chất Lượng Đảm Bảo</h4>
          <p>Sản phẩm chính hãng 100%, cam kết chất lượng tốt nhất</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="feature-box">
          <div class="feature-icon"><i class="fas fa-truck"></i></div>
          <h4>Giao Hàng Nhanh</h4>
          <p>Giao hàng toàn quốc từ 2-4 ngày, miễn phí cho đơn từ 500K</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="feature-box">
          <div class="feature-icon"><i class="fas fa-sync-alt"></i></div>
          <h4>Đổi Trả Dễ Dàng</h4>
          <p>Đổi trả miễn phí trong 30 ngày nếu không hài lòng</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="feature-box">
          <div class="feature-icon"><i class="fas fa-headset"></i></div>
          <h4>Hỗ Trợ 24/7</h4>
          <p>Đội ngũ tư vấn viên luôn sẵn sàng hỗ trợ mọi lúc</p>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer_container">
    <div class="footer-column">
      <h3>Địa điểm cửa hàng</h3>
      <p>
        <strong>TRỤ SỞ:</strong> Trường Đại Học Tài Nguyên Và Môi Trường Hà Nội<br />
        Số 41A đường Phú Diễn, phường Phú Diễn, quận Bắc Từ Liêm, thành phố Hà Nội
      </p>
    </div>
    <div class="footer-column">
      <h3>Kết nối với chúng tôi</h3>
      <ul class="social-icons">
        <li><a href="#"><i class="fab fa-facebook-f"></i></a></li>
        <li><a href="#"><i class="fab fa-youtube"></i></a></li>
        <li><a href="#"><i class="fab fa-instagram"></i></a></li>
      </ul>
    </div>
  </div>
  <div class="container text-center">
    <p>&copy; 2024 Sport Shop. All Rights Reserved.</p>
    <a href="#">Chính sách bảo mật</a> | <a href="#">Điều khoản sử dụng</a>
  </div>
</footer>

<script>
  function changeImage(src) {
    var main = document.getElementById("mainImage");
    if (main) { main.src = src; }
    document.querySelectorAll(".thumbnail").forEach((thumb) => {
      thumb.classList.toggle("active", thumb.src === src);
    });
  }
  function increaseQuantity() {
    const input = document.getElementById("quantity");
    if (!input) return;
    const max = parseInt(input.getAttribute("max") || "9999");
    const currentValue = parseInt(input.value || "1");
    if (currentValue < max) input.value = currentValue + 1;
  }
  function decreaseQuantity() {
    const input = document.getElementById("quantity");
    if (!input) return;
    const cur = parseInt(input.value || "1");
    if (cur > 1) input.value = cur - 1;
  }
</script>
<script>
  // Toggle xem thêm/thu gọn mô tả
  (function(){
    const btn = document.getElementById('descToggleBtn');
    const content = document.getElementById('descContent');
    if(!btn || !content) return;
    btn.addEventListener('click', ()=>{
      content.classList.toggle('collapsed');
      btn.textContent = content.classList.contains('collapsed') ? 'Xem thêm' : 'Thu gọn';
    });
  })();
</script>
<script>
  // Lọc review theo số sao (client-side)
  (function(){
    const container = document.querySelector('.review-filters');
    if(!container) return;

    const pills = container.querySelectorAll('.filter-pill');
    const items = document.querySelectorAll('.review-item');

    function setActive(target){
      pills.forEach(p=>p.classList.remove('active'));
      target.classList.add('active');
    }
    function applyFilter(star){
      items.forEach(it=>{
        const r = it.getAttribute('data-star') || '0';
        it.style.display = (star==='all' || star===r) ? '' : 'none';
      });
    }

    pills.forEach(p=>{
      p.addEventListener('click', ()=>{
        setActive(p);
        applyFilter(p.getAttribute('data-star'));
      });
    });
  })();
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
